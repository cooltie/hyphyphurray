<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypothesis Tester</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #4472C4, #2E5A9C);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(68, 114, 196, 0.3);
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card h2 {
            font-size: 18px;
            color: #4472C4;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8ecf1;
        }
        
        .setup-section {
            background: #fff9e6;
            border-left: 4px solid #f0ad4e;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 12px 12px 0;
        }
        
        .setup-section h3 {
            color: #8a6d3b;
            margin-bottom: 10px;
        }
        
        .setup-section input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .setup-section button {
            margin-top: 15px;
            background: #f0ad4e;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .setup-section button:hover {
            background: #ec971f;
        }
        
        .groups-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 900px) {
            .groups-container {
                grid-template-columns: 1fr;
            }
        }
        
        .group-card {
            padding: 20px;
            border-radius: 10px;
        }
        
        .group-a {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #81c784;
        }
        
        .group-b {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border: 2px solid #ffb74d;
        }
        
        .group-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        .group-a h3 { color: #2e7d32; }
        .group-b h3 { color: #e65100; }
        
        .tag-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .tag-row select, .tag-row input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .hypothesis-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #81c784;
        }
        
        .hypothesis-row label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2e7d32;
            font-size: 13px;
        }
        
        .hypothesis-row select {
            width: 100%;
            padding: 10px;
            border: 1px solid #81c784;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .setting-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 13px;
        }
        
        .setting-item select,
        .setting-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .countries-select {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .country-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            background: #f0f4f8;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .country-checkbox:hover {
            background: #e1e8f0;
        }
        
        .country-checkbox input:checked + span {
            font-weight: 600;
            color: #4472C4;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: 1fr auto 100px;
            gap: 10px;
            align-items: end;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4472C4, #2E5A9C);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(68, 114, 196, 0.4);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-copy {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .btn-copy:hover {
            background: #218838;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .results-table th {
            background: #4472C4;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .result-success {
            color: #28a745;
            font-weight: 600;
        }
        
        .result-fail {
            color: #dc3545;
            font-weight: 600;
        }
        
        .details-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .details-section h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .creatives-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .creatives-table th {
            background: #6c757d;
            color: white;
            padding: 10px;
            text-align: left;
        }
        
        .creatives-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
        }
        
        /* LOADER STYLES */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e8ecf1;
            border-top-color: #4472C4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loader-text {
            margin-top: 20px;
            font-size: 16px;
            color: #4472C4;
            font-weight: 600;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .hidden {
            display: none !important;
        }
        
        .static-value-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
        }
        
        .stat-card .label {
            font-size: 13px;
            opacity: 0.9;
        }
        
        #copyNotification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        
        #copyNotification.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- LOADER -->
    <div class="loader-overlay hidden" id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <div class="container">
        <header>
            <h1>üß™ Hypothesis Tester</h1>
            <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –≥–∏–ø–æ—Ç–µ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets</p>
        </header>
        
        <!-- Setup Section -->
        <div class="setup-section" id="setupSection">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <p>–í—Å—Ç–∞–≤—å URL —Å–≤–æ–µ–≥–æ Google Apps Script –¥–µ–ø–ª–æ—è:</p>
            <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/xxx/exec">
            <br>
            <button onclick="connectToSheets()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <span id="connectionStatus" class="status-badge status-disconnected" style="margin-left: 15px;">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>
        
        <!-- Main Form -->
        <div class="card" id="mainForm">
            <h2>üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–∏–ø–æ—Ç–µ–∑—ã</h2>
            
            <div class="groups-container">
                <!-- Group A -->
                <div class="group-card group-a">
                    <h3>üÖ∞Ô∏è –ì—Ä—É–ø–ø–∞ A (—Ç–µ—Å—Ç–∏—Ä—É–µ–º)</h3>
                    
                    <!-- Hypothesis ID - —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–µ A -->
                    <div class="hypothesis-row">
                        <label>üìã Hypothesis ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <select id="hypothesisId">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—É --</option>
                        </select>
                    </div>
                    
                    <div class="tag-row">
                        <select id="tagType1A" onchange="updateValueDropdown('tagType1A', 'tagValue1A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 1 --</option>
                        </select>
                        <select id="tagValue1A">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>
                    
                    <div class="tag-row">
                        <select id="tagType2A" onchange="updateValueDropdown('tagType2A', 'tagValue2A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 2 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue2A">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>
                    
                    <div class="tag-row">
                        <select id="tagType3A" onchange="updateValueDropdown('tagType3A', 'tagValue3A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 3 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue3A">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>
                </div>
                
                <!-- Group B -->
                <div class="group-card group-b">
                    <h3>üÖ±Ô∏è –ì—Ä—É–ø–ø–∞ B (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å)</h3>
                    
                    <div class="tag-row">
                        <select id="tagType1B" onchange="updateValueDropdown('tagType1B', 'tagValue1B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 1 --</option>
                        </select>
                        <select id="tagValue1B">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>
                    
                    <div class="tag-row">
                        <select id="tagType2B" onchange="updateValueDropdown('tagType2B', 'tagValue2B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 2 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue2B">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>
                    
                    <div class="tag-row">
                        <select id="tagType3B" onchange="updateValueDropdown('tagType3B', 'tagValue3B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 3 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue3B">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>
                    
                    <div class="static-value-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useStaticValue" onchange="toggleStaticValue()">
                            <span>–°—Ä–∞–≤–Ω–∏—Ç—å —Å–æ —Å—Ç–∞—Ç–∏—á–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º</span>
                        </label>
                        <input type="number" id="staticValue" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ" style="margin-top: 10px; display: none;">
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div class="card" style="background: #f8f9fa;">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>–°—Ç—Ä–∞–Ω—ã</label>
                        <div class="countries-select">
                            <label class="country-checkbox">
                                <input type="checkbox" value="EU" checked>
                                <span>EU</span>
                            </label>
                            <label class="country-checkbox">
                                <input type="checkbox" value="DE">
                                <span>DE</span>
                            </label>
                            <label class="country-checkbox">
                                <input type="checkbox" value="FR">
                                <span>FR</span>
                            </label>
                            <label class="country-checkbox">
                                <input type="checkbox" value="IT">
                                <span>IT</span>
                            </label>
                            <label class="country-checkbox">
                                <input type="checkbox" value="NL">
                                <span>NL</span>
                            </label>
                        </div>
                    </div>
                    
                  <div class="setting-item">
                    <label>–ú–µ—Ç—Ä–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</label>
                    <select id="metric">
                        <option value="CTR">CTR (Click-through Rate)</option>
                        <option value="CPA_Onboarded">CPA Onboarded</option>
                        <option value="CPA_Account_Open">CPA Account Open</option>
                        <option value="CPA_Onboarded_2">CPA Onboarded (Onb>2)</option>
                        <option value="CR">CR (Account/Onboarded)</option>
                        <option value="ThruPlay_Rate">ThruPlay Rate</option>
                    </select>
                </div>
                    
                    <div class="setting-item">
                        <label>–£—Å–ª–æ–≤–∏–µ</label>
                        <select id="condition">
                            <option value="greater">A –±–æ–ª—å—à–µ B</option>
                            <option value="less">A –º–µ–Ω—å—à–µ B</option>
                            <option value="greaterPercent">A –±–æ–ª—å—à–µ B –Ω–∞ %</option>
                            <option value="lessPercent">A –º–µ–Ω—å—à–µ B –Ω–∞ %</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label>–ó–Ω–∞—á–µ–Ω–∏–µ % (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</label>
                        <input type="number" id="conditionValue" value="10" min="0" max="100">
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #555; font-size: 13px; display: block; margin-bottom: 8px;">–§–∏–ª—å—Ç—Ä –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <div class="filter-row">
                        <select id="filterMetric">
                            <option value="">-- –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ --</option>
                            <option value="Onboarded">Onboarded</option>
                            <option value="Impressions">Impressions</option>
                            <option value="Amount Spent">Amount Spent</option>
                        </select>
                        <select id="filterOperator">
                            <option value=">">&gt;</option>
                            <option value="<">&lt;</option>
                            <option value="=">=</option>
                            <option value=">=">&gt;=</option>
                            <option value="<=">&lt;=</option>
                        </select>
                        <input type="number" id="filterValue" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="0">
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-primary" id="runTest" onclick="runHypothesisTest()" disabled>
                    üöÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É
                </button>
            </div>
        </div>
        
        <!-- Results -->
        <div class="card hidden" id="resultsSection">
            <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã <button class="btn-copy" onclick="copyResultsToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è Sheets</button></h2>
            
            <div class="summary-stats" id="summaryStats"></div>
            
            <table class="results-table">
                <thead>
                    <tr>
                        <th>–°—Ç—Ä–∞–Ω–∞</th>
                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ A</th>
                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ B</th>
                        <th>–†–∞–∑–Ω–∏—Ü–∞</th>
                        <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                </tbody>
            </table>
            
            <div class="details-section hidden" id="detailsSection">
                <h4 id="detailsTitle">–î–µ—Ç–∞–ª–∏</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5 style="color: #2e7d32; margin-bottom: 10px;">–ì—Ä—É–ø–ø–∞ A –∫—Ä–µ–∞—Ç–∏–≤—ã:</h5>
                        <table class="creatives-table" id="creativesTableA">
                            <thead>
                                <tr>
                                    <th>Ad Name</th>
                                    <th>Spent</th>
                                    <th>Onboarded</th>
                                    <th>CPA</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <div>
                        <h5 style="color: #e65100; margin-bottom: 10px;">–ì—Ä—É–ø–ø–∞ B –∫—Ä–µ–∞—Ç–∏–≤—ã:</h5>
                        <table class="creatives-table" id="creativesTableB">
                            <thead>
                                <tr>
                                    <th>Ad Name</th>
                                    <th>Spent</th>
                                    <th>Onboarded</th>
                                    <th>CPA</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="copyNotification">‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</div>
    
    <script>
        // Global data
        let sheetsData = [];
        let tagConfig = {};
        let hypothesisIds = [];
        let lastResults = [];
        
        // –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ —Ç–µ–≥–æ–≤ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –≤ Combined_results
        // –ö–ª—é—á = –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ Config, –ó–Ω–∞—á–µ–Ω–∏–µ = –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ Combined_results
        const tagTypeToColumn = {
            'GEO': 'GEO',
            'Language': 'Language',
            'Lane': 'Lane',
            'Campaign Type': 'Campaign Type',
            'Stage': 'Stage',
            'Style': 'Style',
            'Variable': 'Variable',
            'Variant': 'Variant',
            'Placement': 'Platform/Placement',
            'Format': 'Format',
            'Length': 'Length',
            'CTA_Tag': 'CTA Tag',
            'Hook_Tag': 'Hook Tag',
            'Format_Tag': 'Format Tag',
            'Style_Tag': 'Style Tag',
            'Audience': 'Audience Tag',
            'Visual_Tag': 'Visual Tag 1'
        };
        
        // Initialize tag type dropdowns (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ü–∏–∏ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö)
        function initTagDropdowns() {
            const selects = ['tagType1A', 'tagType2A', 'tagType3A', 'tagType1B', 'tagType2B', 'tagType3B'];
            const defaultOptions = Object.keys(tagTypeToColumn);
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>';
                defaultOptions.forEach(opt => {
                    select.innerHTML += `<option value="${opt}">${opt}</option>`;
                });
            });
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
        function updateValueDropdown(typeSelectId, valueSelectId) {
            const typeSelect = document.getElementById(typeSelectId);
            const valueSelect = document.getElementById(valueSelectId);
            const selectedType = typeSelect.value;
            
            // –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏
            valueSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ --</option>';
            
            if (!selectedType) {
                valueSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>';
                return;
            }
            
            // –ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ tagConfig
            const values = tagConfig[selectedType] || [];
            
            if (values.length === 0) {
                valueSelect.innerHTML = '<option value="">-- –ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π --</option>';
                return;
            }
            
            values.forEach(val => {
                if (val) {
                    valueSelect.innerHTML += `<option value="${val}">${val}</option>`;
                }
            });
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω Hypothesis ID
        function updateHypothesisDropdown() {
            const select = document.getElementById('hypothesisId');
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—É --</option>';
            
            hypothesisIds.forEach(id => {
                if (id) {
                    select.innerHTML += `<option value="${id}">${id}</option>`;
                }
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ª–æ–∞–¥–µ—Ä
        function showLoader(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...') {
            const loader = document.getElementById('loader');
            const loaderText = loader.querySelector('.loader-text');
            loaderText.textContent = text;
            
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }
        
        // Connect to Google Sheets
        async function connectToSheets() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                alert('–í–≤–µ–¥–∏—Ç–µ URL Apps Script');
                return;
            }
            
            const status = document.getElementById('connectionStatus');
            status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            status.className = 'status-badge';
            
            showLoader(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets...');
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
                sheetsData = data.adsData || [];
                tagConfig = data.tagConfig || {};
                hypothesisIds = data.hypothesisIds || [];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω—ã —Ç–∏–ø–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ Config
                updateTypeDropdownsFromConfig();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥—Ä–æ–ø–¥–∞—É–Ω –≥–∏–ø–æ—Ç–µ–∑
                updateHypothesisDropdown();
                
                status.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ (${sheetsData.length} —Å—Ç—Ä–æ–∫)`;
                status.className = 'status-badge status-connected';
                document.getElementById('runTest').disabled = false;
                
                // Save URL to localStorage
                localStorage.setItem('sheetsScriptUrl', url);
                
            } catch (error) {
                status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                status.className = 'status-badge status-disconnected';
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                showLoader(false);
            }
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω—ã —Ç–∏–ø–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Config
        function updateTypeDropdownsFromConfig() {
            const selects = ['tagType1A', 'tagType2A', 'tagType3A', 'tagType1B', 'tagType2B', 'tagType3B'];
            const configKeys = Object.keys(tagConfig);
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>';
                configKeys.forEach(key => {
                    select.innerHTML += `<option value="${key}">${key}</option>`;
                });
                
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å –≤ –Ω–æ–≤—ã—Ö –æ–ø—Ü–∏—è—Ö
                if (currentValue && configKeys.includes(currentValue)) {
                    select.value = currentValue;
                }
            });
        }
        
        // Toggle static value input
        function toggleStaticValue() {
            const checkbox = document.getElementById('useStaticValue');
            const input = document.getElementById('staticValue');
            const groupBInputs = document.querySelectorAll('#tagType1B, #tagValue1B, #tagType2B, #tagValue2B, #tagType3B, #tagValue3B');
            
            if (checkbox.checked) {
                input.style.display = 'block';
                groupBInputs.forEach(el => el.disabled = true);
            } else {
                input.style.display = 'none';
                groupBInputs.forEach(el => el.disabled = false);
            }
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ Combined_results –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∏–∑ Config
        function getColumnForType(configKey) {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–ø–ø–∏–Ω–≥
            if (tagTypeToColumn[configKey]) {
                return tagTypeToColumn[configKey];
            }
            // –ï—Å–ª–∏ –Ω–µ—Ç –≤ –º–∞–ø–ø–∏–Ω–≥–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç)
            return configKey;
        }
        
        // Filter data by tags and country
        function filterData(data, tags, country) {
            return data.filter(row => {
                // Country filter
                if (country && row['GEO'] !== country) return false;
                
                // Tag filters
                for (const tag of tags) {
                    if (tag.type && tag.value) {
                        const columnName = getColumnForType(tag.type);
                        if (columnName && row[columnName] !== undefined) {
                            if (String(row[columnName]).toLowerCase() !== String(tag.value).toLowerCase()) {
                                return false;
                            }
                        } else {
                            return false;
                        }
                    }
                }
                
                return true;
            });
        }
        
        // Filter by Hypothesis ID
        function filterByHypothesis(data, hypId) {
            if (!hypId) return data;
            return data.filter(row => row['Hypothesis ID'] === hypId);
        }
        
        // Apply data filter (e.g., Onboarded > 2)
        function applyDataFilter(data) {
            const filterMetric = document.getElementById('filterMetric').value;
            const filterOperator = document.getElementById('filterOperator').value;
            const filterValue = parseFloat(document.getElementById('filterValue').value) || 0;
            
            if (!filterMetric) return data;
            
            return data.filter(row => {
                const value = parseFloat(row[filterMetric]) || 0;
                switch (filterOperator) {
                    case '>': return value > filterValue;
                    case '<': return value < filterValue;
                    case '=': return value === filterValue;
                    case '>=': return value >= filterValue;
                    case '<=': return value <= filterValue;
                    default: return true;
                }
            });
        }
        
// Calculate metric for a dataset
function calculateMetric(data, metric) {
    if (data.length === 0) return null;
    
    // –î–ª—è CPA Onboarded (Onb>2) ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    let filteredData = data;
    if (metric === 'CPA_Onboarded_2') {
        filteredData = data.filter(row => (parseFloat(row['Onboarded']) || 0) > 2);
        if (filteredData.length === 0) return null;
    }
    
    const totalSpent = filteredData.reduce((sum, row) => sum + (parseFloat(row['Amount Spent']) || 0), 0);
    const totalOnboarded = filteredData.reduce((sum, row) => sum + (parseFloat(row['Onboarded']) || 0), 0);
    const totalAccountOpened = filteredData.reduce((sum, row) => sum + (parseFloat(row['OBA: Account Opened']) || 0), 0);
    const totalImpressions = filteredData.reduce((sum, row) => sum + (parseFloat(row['Impressions']) || 0), 0);
    const totalThruPlays = filteredData.reduce((sum, row) => sum + (parseFloat(row['ThruPlays']) || 0), 0);
    
    // CTR –±–µ—Ä—ë–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ –∏ —É—Å—Ä–µ–¥–Ω—è–µ–º
    const ctrValues = filteredData.map(row => parseFloat(row['CTR (Link Click-Through Rate)']) || 0);
    const avgCTR = ctrValues.length > 0 ? ctrValues.reduce((a, b) => a + b, 0) / ctrValues.length : null;
    
    switch (metric) {
        case 'CTR':
            return avgCTR;
        case 'CPA_Onboarded':
            return totalOnboarded > 0 ? totalSpent / totalOnboarded : null;
        case 'CPA_Account_Open':
            return totalAccountOpened > 0 ? totalSpent / totalAccountOpened : null;
        case 'CPA_Onboarded_2':
            return totalOnboarded > 0 ? totalSpent / totalOnboarded : null;
        case 'CR':
            return totalOnboarded > 0 ? (totalAccountOpened / totalOnboarded) * 100 : null;
        case 'ThruPlay_Rate':
            return totalImpressions > 0 ? (totalThruPlays / totalImpressions) * 100 : null;
        default:
            return null;
    }
}       
        // Check if hypothesis passed
        function checkCondition(valueA, valueB, condition, conditionValue) {
            if (valueA === null || valueB === null) return null;
            
            switch (condition) {
                case 'greater':
                    return valueA > valueB;
                case 'less':
                    return valueA < valueB;
                case 'greaterPercent':
                    return valueA > valueB * (1 + conditionValue / 100);
                case 'lessPercent':
                    return valueA < valueB * (1 - conditionValue / 100);
                default:
                    return null;
            }
        }
        
        // Run the hypothesis test
        function runHypothesisTest() {
            // Get Hypothesis ID filter
            const hypId = document.getElementById('hypothesisId').value;
            
            // Get tags for Group A
            const tagsA = [
                { type: document.getElementById('tagType1A').value, value: document.getElementById('tagValue1A').value },
                { type: document.getElementById('tagType2A').value, value: document.getElementById('tagValue2A').value },
                { type: document.getElementById('tagType3A').value, value: document.getElementById('tagValue3A').value }
            ].filter(t => t.type && t.value);
            
            // Get tags for Group B
            const useStatic = document.getElementById('useStaticValue').checked;
            const staticValue = parseFloat(document.getElementById('staticValue').value) || 0;
            
            const tagsB = useStatic ? [] : [
                { type: document.getElementById('tagType1B').value, value: document.getElementById('tagValue1B').value },
                { type: document.getElementById('tagType2B').value, value: document.getElementById('tagValue2B').value },
                { type: document.getElementById('tagType3B').value, value: document.getElementById('tagValue3B').value }
            ].filter(t => t.type && t.value);
            
            // Get selected countries
            const countries = Array.from(document.querySelectorAll('.country-checkbox input:checked')).map(cb => cb.value);
            
            // Get settings
            const metric = document.getElementById('metric').value;
            const condition = document.getElementById('condition').value;
            const conditionValue = parseFloat(document.getElementById('conditionValue').value) || 0;
            
            // Filter base data
            let filteredData = applyDataFilter(sheetsData);
            
            // Apply hypothesis filter if selected
            filteredData = filterByHypothesis(filteredData, hypId);
            
            // Calculate for each country
            lastResults = [];
            let successCount = 0;
            
            countries.forEach(country => {
                const dataA = filterData(filteredData, tagsA, country);
                const dataB = useStatic ? [] : filterData(filteredData, tagsB, country);
                
                const valueA = calculateMetric(dataA, metric);
                const valueB = useStatic ? staticValue : calculateMetric(dataB, metric);
                
                const passed = checkCondition(valueA, valueB, condition, conditionValue);
                if (passed) successCount++;
                
                const diff = valueA !== null && valueB !== null && valueB !== 0 
                    ? ((valueA - valueB) / valueB * 100) 
                    : null;
                
                lastResults.push({
                    country,
                    valueA,
                    valueB,
                    diff,
                    passed,
                    dataA,
                    dataB
                });
            });
            
            // Display results
            displayResults(lastResults, metric, successCount, countries.length);
        }
        
        // Display results
        function displayResults(results, metric, successCount, totalCount) {
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Summary stats
            const summaryHtml = `
                <div class="stat-card">
                    <div class="number">${successCount}/${totalCount}</div>
                    <div class="label">–°—Ä–∞–±–æ—Ç–∞–ª–æ</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #11998e, #38ef7d);">
                    <div class="number">${Math.round(successCount / totalCount * 100)}%</div>
                    <div class="label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = summaryHtml;
            
            // Results table
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            results.forEach((result, index) => {
                const formatValue = (v) => v !== null ? v.toFixed(2) : 'N/A';
                const formatDiff = (d) => d !== null ? (d >= 0 ? '+' : '') + d.toFixed(1) + '%' : 'N/A';
                
                const resultClass = result.passed === true ? 'result-success' : 
                                   result.passed === false ? 'result-fail' : '';
                const resultText = result.passed === true ? '‚úÖ –°—Ä–∞–±–æ—Ç–∞–ª–æ' : 
                                  result.passed === false ? '‚ùå –ù–µ—Ç' : '‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${result.country}</strong></td>
                    <td>${formatValue(result.valueA)}</td>
                    <td>${formatValue(result.valueB)}</td>
                    <td>${formatDiff(result.diff)}</td>
                    <td class="${resultClass}">${resultText}</td>
                    <td><button onclick="showDetails(${index})" style="padding: 5px 10px; cursor: pointer;">üëÅÔ∏è –î–µ—Ç–∞–ª–∏</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Show details for a specific country
        function showDetails(index) {
            const result = lastResults[index];
            document.getElementById('detailsSection').classList.remove('hidden');
            document.getElementById('detailsTitle').textContent = `–î–µ—Ç–∞–ª–∏ –¥–ª—è ${result.country}`;
            
            // Populate Group A table
            const tbodyA = document.querySelector('#creativesTableA tbody');
            tbodyA.innerHTML = '';
            result.dataA.slice(0, 20).forEach(row => {
                const spent = parseFloat(row['Amount Spent']) || 0;
                const onb = parseFloat(row['Onboarded']) || 0;
                const cpa = onb > 0 ? (spent / onb).toFixed(2) : 'N/A';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Ad Name'] || 'N/A'}</td>
                    <td>‚Ç¨${spent.toFixed(2)}</td>
                    <td>${onb}</td>
                    <td>${cpa}</td>
                `;
                tbodyA.appendChild(tr);
            });
            
            // Populate Group B table
            const tbodyB = document.querySelector('#creativesTableB tbody');
            tbodyB.innerHTML = '';
            result.dataB.slice(0, 20).forEach(row => {
                const spent = parseFloat(row['Amount Spent']) || 0;
                const onb = parseFloat(row['Onboarded']) || 0;
                const cpa = onb > 0 ? (spent / onb).toFixed(2) : 'N/A';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Ad Name'] || 'N/A'}</td>
                    <td>‚Ç¨${spent.toFixed(2)}</td>
                    <td>${onb}</td>
                    <td>${cpa}</td>
                `;
                tbodyB.appendChild(tr);
            });
        }
        
        // Copy results to clipboard (tab-separated for Google Sheets)
        function copyResultsToClipboard() {
            const metric = document.getElementById('metric').value;
            
            // Header
            let text = `–°—Ç—Ä–∞–Ω–∞\t–ó–Ω–∞—á–µ–Ω–∏–µ A\t–ó–Ω–∞—á–µ–Ω–∏–µ B\t–†–∞–∑–Ω–∏—Ü–∞ %\t–†–µ–∑—É–ª—å—Ç–∞—Ç\n`;
            
            // Data rows
            lastResults.forEach(result => {
                const valueA = result.valueA !== null ? result.valueA.toFixed(2) : 'N/A';
                const valueB = result.valueB !== null ? result.valueB.toFixed(2) : 'N/A';
                const diff = result.diff !== null ? result.diff.toFixed(1) + '%' : 'N/A';
                const passed = result.passed === true ? '–°—Ä–∞–±–æ—Ç–∞–ª–æ' : 
                              result.passed === false ? '–ù–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                text += `${result.country}\t${valueA}\t${valueB}\t${diff}\t${passed}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                const notification = document.getElementById('copyNotification');
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 2000);
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTagDropdowns();
            
            // Restore saved URL
            const savedUrl = localStorage.getItem('sheetsScriptUrl');
            if (savedUrl) {
                document.getElementById('scriptUrl').value = savedUrl;
            }
        });
    </script>
</body>
</html>
