<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypothesis Tester v2.0</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #4472C4, #2E5A9C);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(68, 114, 196, 0.3);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            font-size: 18px;
            color: #4472C4;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8ecf1;
        }

        .setup-section {
            background: #fff9e6;
            border-left: 4px solid #f0ad4e;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 12px 12px 0;
        }

        .setup-section input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
        }

        .setup-section button {
            margin-top: 15px;
            background: #f0ad4e;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .groups-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .group-card {
            padding: 20px;
            border-radius: 10px;
        }

        .group-a {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #81c784;
        }

        .group-b {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border: 2px solid #ffb74d;
        }

        .tag-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .tag-row select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            width: 100%;
        }

        .hyp-id-row {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .hyp-id-row label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .hyp-id-row select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #81c784;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4472C4, #2E5A9C);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .hidden {
            display: none;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .results-table th {
            background: #4472C4;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .result-success {
            color: #28a745;
            font-weight: bold;
        }

        .result-fail {
            color: #dc3545;
            font-weight: bold;
        }

        .country-checkbox {
            display: inline-flex;
            align-items: center;
            background: #eee;
            padding: 5px 10px;
            border-radius: 15px;
            margin: 2px;
            cursor: pointer;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üß™ Hypothesis Tester</h1>
            <p>–ê–Ω–∞–ª–∏–∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –≥–∏–ø–æ—Ç–µ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö All_Ads_Data</p>
        </header>

        <div class="setup-section">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <input type="text" id="scriptUrl" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ URL Google Apps Script">
            <button onclick="connectToSheets()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ç–∞–±–ª–∏—Ü–µ</button>
            <span id="connectionStatus" class="status-badge status-disconnected">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>

        <div class="card" id="mainForm">
            <div class="groups-container">
                <div class="group-card group-a">
                    <h3>üÖ∞Ô∏è –ì—Ä—É–ø–ø–∞ A (–¢–µ—Å—Ç–∏—Ä—É–µ–º–∞—è)</h3>
                    <div class="hyp-id-row" style="border-top:none; margin-top:0; padding-top:0; margin-bottom:15px;">
                        <label>HYPOTHESIS ID (–§–∏–ª—å—Ç—Ä)</label>
                        <select id="hypothesisIdA">
                            <option value="">-- –í—Å–µ –≥–∏–ø–æ—Ç–µ–∑—ã --</option>
                        </select>
                    </div>
                    <div class="tag-row">
                        <select id="tagType1A" onchange="updateValueDropdown('1A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 1 --</option>
                        </select>
                        <select id="tagValue1A">
                            <option value="">-- –ó–Ω–∞—á–µ–Ω–∏–µ --</option>
                        </select>
                    </div>
                    <div class="tag-row">
                        <select id="tagType2A" onchange="updateValueDropdown('2A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 2 --</option>
                        </select>
                        <select id="tagValue2A">
                            <option value="">-- –ó–Ω–∞—á–µ–Ω–∏–µ --</option>
                        </select>
                    </div>
                    <div class="tag-row">
                        <select id="tagType3A" onchange="updateValueDropdown('3A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 3 --</option>
                        </select>
                        <select id="tagValue3A">
                            <option value="">-- –ó–Ω–∞—á–µ–Ω–∏–µ --</option>
                        </select>
                    </div>
                </div>

                <div class="group-card group-b">
                    <h3>üÖ±Ô∏è –ì—Ä—É–ø–ø–∞ B (–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è)</h3>
                    <div class="tag-row">
                        <select id="tagType1B" onchange="updateValueDropdown('1B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 1 --</option>
                        </select>
                        <select id="tagValue1B">
                            <option value="">-- –ó–Ω–∞—á–µ–Ω–∏–µ --</option>
                        </select>
                    </div>
                    <div class="tag-row">
                        <select id="tagType2B" onchange="updateValueDropdown('2B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 2 --</option>
                        </select>
                        <select id="tagValue2B">
                            <option value="">-- –ó–Ω–∞—á–µ–Ω–∏–µ --</option>
                        </select>
                    </div>
                    <div class="tag-row">
                        <select id="tagType3B" onchange="updateValueDropdown('3B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 3 --</option>
                        </select>
                        <select id="tagValue3B">
                            <option value="">-- –ó–Ω–∞—á–µ–Ω–∏–µ --</option>
                        </select>
                    </div>
                    <div style="margin-top:10px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 8px;">
                        <label style="cursor:pointer"><input type="checkbox" id="useStaticValue"
                                onchange="toggleStaticValue()"> –°—Ä–∞–≤–Ω–∏—Ç—å —Å–æ —Å—Ç–∞—Ç–∏–∫–æ–π</label>
                        <input type="number" id="staticValue" class="hidden" placeholder="–í–≤–µ–¥–∏—Ç–µ CPA/CPM..."
                            style="width:100%; padding:8px; margin-top:5px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                </div>
            </div>

            <div class="card" style="background: #f8f9fa;">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h2>
                <div class="settings-grid">
                    <div>
                        <label>–°—Ç—Ä–∞–Ω—ã (GEO)</label>
                        <div id="countryList" style="margin-top:5px">
                        </div>
                    </div>
                    <div>
                        <label>–ú–µ—Ç—Ä–∏–∫–∞</label>
                        <select id="metric" style="width:100%; padding:10px; border-radius:6px">
                            <option value="CPA">CPA (Cost per Onboarded)</option>
                            <option value="CPM">CPM (Cost per 1000 Imp)</option>
                            <option value="CTR">CTR (%)</option>
                            <option value="Onboarded">Onboarded (Abs)</option>
                            <option value="Amount Spent">Spend (‚Ç¨)</option>
                        </select>
                    </div>
                    <div>
                        <label>–£—Å–ª–æ–≤–∏–µ —É—Å–ø–µ—Ö–∞</label>
                        <select id="condition" style="width:100%; padding:10px; border-radius:6px">
                            <option value="less">–ì—Ä—É–ø–ø–∞ A –º–µ–Ω—å—à–µ B (–ª—É—á—à–µ)</option>
                            <option value="greater">–ì—Ä—É–ø–ø–∞ A –±–æ–ª—å—à–µ B</option>
                        </select>
                    </div>
                </div>
                <button class="btn-primary" id="runTest" onclick="runHypothesisTest()" disabled
                    style="margin-top:20px; font-size: 18px;">üöÄ –ü–†–û–í–ï–†–ò–¢–¨ –ì–ò–ü–û–¢–ï–ó–£</button>
            </div>
        </div>

        <div class="card hidden" id="resultsSection">
            <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h2>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>GEO</th>
                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ A</th>
                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ B</th>
                        <th>–†–∞–∑–Ω–∏—Ü–∞ %</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let sheetsData = [];
        let tagConfig = {};
        let hypothesisIds = [];

        async function connectToSheets() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) return alert("–í—Å—Ç–∞–≤—å—Ç–µ URL!");

            const status = document.getElementById('connectionStatus');
            status.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';

            try {
                const response = await fetch(url);
                const data = await response.json();

                sheetsData = data.adsData;
                tagConfig = data.tagConfig;
                hypothesisIds = data.hypothesisIds;

                status.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${sheetsData.length} —Å—Ç—Ä–æ–∫`;
                status.className = 'status-badge status-connected';
                document.getElementById('runTest').disabled = false;

                fillInitialDropdowns();
                fillCountryCheckboxes();
                localStorage.setItem('sheetsScriptUrl', url);
            } catch (e) {
                console.error(e);
                status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                status.className = 'status-badge status-disconnected';
            }
        }

        function fillInitialDropdowns() {
            // –¢–∏–ø—ã —Ç–µ–≥–æ–≤
            const typeSelects = ['tagType1A', 'tagType2A', 'tagType3A', 'tagType1B', 'tagType2B', 'tagType3B'];
            const tags = Object.keys(tagConfig);

            typeSelects.forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '<option value="">-- –¢–∏–ø —Ç–µ–≥–∞ --</option>';
                tags.forEach(t => s.innerHTML += `<option value="${t}">${t}</option>`);
            });

            // ID –ì–∏–ø–æ—Ç–µ–∑ –¥–ª—è –ì—Ä—É–ø–ø—ã –ê
            const hypSelect = document.getElementById('hypothesisIdA');
            hypSelect.innerHTML = '<option value="">-- –í—Å–µ –≥–∏–ø–æ—Ç–µ–∑—ã (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ ID) --</option>';
            hypothesisIds.forEach(id => {
                hypSelect.innerHTML += `<option value="${id}">${id}</option>`;
            });
        }

        function fillCountryCheckboxes() {
            const countries = tagConfig['GEO'] || ['EU', 'DE', 'FR', 'IT', 'NL'];
            const container = document.getElementById('countryList');
            container.innerHTML = '';
            countries.forEach(c => {
                container.innerHTML += `
                    <label class="country-checkbox">
                        <input type="checkbox" value="${c}" checked> ${c}
                    </label>
                `;
            });
        }

        function updateValueDropdown(suffix) {
            const type = document.getElementById('tagType' + suffix).value;
            const valSelect = document.getElementById('tagValue' + suffix);
            valSelect.innerHTML = '<option value="">-- –ó–Ω–∞—á–µ–Ω–∏–µ --</option>';

            if (type && tagConfig[type]) {
                tagConfig[type].forEach(v => {
                    valSelect.innerHTML += `<option value="${v}">${v}</option>`;
                });
            }
        }

        function toggleStaticValue() {
            const isChecked = document.getElementById('useStaticValue').checked;
            document.getElementById('staticValue').classList.toggle('hidden', !isChecked);
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä —Ç–µ–≥–æ–≤ –¥–ª—è B, –µ—Å–ª–∏ —é–∑–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É
            const bSelects = ['tagType1B', 'tagValue1B', 'tagType2B', 'tagValue2B', 'tagType3B', 'tagValue3B'];
            bSelects.forEach(id => document.getElementById(id).disabled = isChecked);
        }

        // –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –§–ò–õ–¨–¢–†–ê–¶–ò–ò
        function getFilteredData(groupPrefix, country) {
            let tags = [];
            for (let i = 1; i <= 3; i++) {
                const type = document.getElementById(`tagType${i}${groupPrefix}`).value;
                const val = document.getElementById(`tagValue${i}${groupPrefix}`).value;
                if (type && val) tags.push({ type, val });
            }

            const hypId = groupPrefix === 'A' ? document.getElementById('hypothesisIdA').value : '';

            return sheetsData.filter(row => {
                // 1. –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–µ
                if (row['GEO'] !== country) return false;

                // 2. –§–∏–ª—å—Ç—Ä –ø–æ ID –ì–∏–ø–æ—Ç–µ–∑—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –ì—Ä—É–ø–ø—ã –ê, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω)
                if (groupPrefix === 'A' && hypId) {
                    if (String(row['Hypothesis ID']) !== String(hypId)) return false;
                }

                // 3. –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
                for (let tag of tags) {
                    if (String(row[tag.type]).toLowerCase() !== String(tag.val).toLowerCase()) return false;
                }

                return true;
            });
        }

        function calculateMetric(data, metric) {
            if (data.length === 0) return null;

            const sum = (key) => data.reduce((acc, row) => acc + (parseFloat(row[key]) || 0), 0);

            const spent = sum('Amount Spent');
            const onboarded = sum('Onboarded');
            const impressions = sum('Impressions');
            const clicks = sum('Link Clicks');

            switch (metric) {
                case 'CPA': return onboarded > 0 ? spent / onboarded : 0;
                case 'CPM': return impressions > 0 ? (spent / impressions) * 1000 : 0;
                case 'CTR': return impressions > 0 ? (clicks / impressions) * 100 : 0;
                case 'Onboarded': return onboarded;
                case 'Amount Spent': return spent;
                default: return 0;
            }
        }

        function runHypothesisTest() {
            const metric = document.getElementById('metric').value;
            const condition = document.getElementById('condition').value;
            const useStatic = document.getElementById('useStaticValue').checked;
            const staticVal = parseFloat(document.getElementById('staticValue').value) || 0;

            const selectedCountries = Array.from(document.querySelectorAll('#countryList input:checked')).map(i => i.value);
            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = '';

            selectedCountries.forEach(country => {
                const dataA = getFilteredData('A', country);
                const valA = calculateMetric(dataA, metric);

                let valB;
                if (useStatic) {
                    valB = staticVal;
                } else {
                    const dataB = getFilteredData('B', country);
                    valB = calculateMetric(dataB, metric);
                }

                if (valA === null || (valB === null && !useStatic)) return;

                const diff = valB !== 0 ? ((valA - valB) / valB * 100) : 0;

                let isSuccess = false;
                if (condition === 'less') isSuccess = valA < valB;
                else isSuccess = valA > valB;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${country}</strong></td>
                    <td>${valA.toFixed(2)}</td>
                    <td>${valB.toFixed(2)}</td>
                    <td style="color: ${diff > 0 ? 'red' : 'green'}">${diff > 0 ? '+' : ''}${diff.toFixed(1)}%</td>
                    <td class="${isSuccess ? 'result-success' : 'result-fail'}">
                        ${isSuccess ? '‚úÖ –°—Ä–∞–±–æ—Ç–∞–ª–æ' : '‚ùå –ù–µ—Ç'}
                    </td>
                `;
                resultsBody.appendChild(row);
            });

            document.getElementById('resultsSection').classList.remove('hidden');
        }

        window.onload = () => {
            const saved = localStorage.getItem('sheetsScriptUrl');
            if (saved) document.getElementById('scriptUrl').value = saved;
        };
    </script>
</body>

</html>