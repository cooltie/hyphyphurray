<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypothesis Tester</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #4472C4, #2E5A9C);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(68, 114, 196, 0.3);
        }

        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            font-size: 18px;
            color: #4472C4;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8ecf1;
        }

        .setup-section {
            background: #fff9e6;
            border-left: 4px solid #f0ad4e;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 0 12px 12px 0;
        }

        .setup-section h3 {
            color: #8a6d3b;
            margin-bottom: 10px;
        }

        .setup-section input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 10px;
        }

        .setup-section button {
            margin-top: 15px;
            background: #f0ad4e;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .setup-section button:hover {
            background: #ec971f;
        }

        .groups-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        @media (max-width: 900px) {
            .groups-container {
                grid-template-columns: 1fr;
            }
        }

        .group-card {
            padding: 20px;
            border-radius: 10px;
        }

        .group-a {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border: 2px solid #81c784;
        }

        .group-b {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border: 2px solid #ffb74d;
        }

        .group-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .group-a h3 {
            color: #2e7d32;
        }

        .group-b h3 {
            color: #e65100;
        }

        .tag-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .tag-row select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .hypothesis-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #81c784;
        }

        .hypothesis-row label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2e7d32;
            font-size: 13px;
        }

        .hypothesis-row select {
            width: 100%;
            padding: 10px;
            border: 1px solid #81c784;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .settings-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
            gap: 24px;
            align-items: flex-start;
        }

        @media (max-width: 900px) {
            .settings-layout {
                grid-template-columns: 1fr;
            }
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .setting-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 13px;
        }

        .setting-item select,
        .setting-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr auto 110px;
            gap: 10px;
            align-items: end;
        }

        .filter-row select,
        .filter-row input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .filter-row input {
            max-width: 140px;
            justify-self: flex-start;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4472C4, #2E5A9C);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(68, 114, 196, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-copy {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }

        .btn-copy:hover {
            background: #218838;
        }

        .btn-analyze {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
        }

        .btn-analyze:hover {
            background: #5a32a3;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th {
            background: #4472C4;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .result-success {
            color: #28a745;
            font-weight: 600;
        }

        .result-fail {
            color: #dc3545;
            font-weight: 600;
        }

        .details-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .details-section h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .creatives-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 10px;
        }

        .creatives-table th {
            background: #6c757d;
            color: white;
            padding: 10px;
            text-align: left;
        }

        .creatives-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #ddd;
        }

        /* LOADER STYLES */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e8ecf1;
            border-top-color: #4472C4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            margin-top: 20px;
            font-size: 16px;
            color: #4472C4;
            font-weight: 600;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .hidden {
            display: none !important;
        }

        .static-value-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .static-input {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            border: 1px solid #ffb74d;
            border-radius: 6px;
            font-size: 14px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
        }

        .stat-card .label {
            font-size: 13px;
            opacity: 0.9;
        }

        .result-box {
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .result-box.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
        }

        .result-box.fail {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border: 2px solid #dc3545;
        }

        .result-box.nodata {
            background: linear-gradient(135deg, #fff3cd, #ffeeba);
            border: 2px solid #ffc107;
        }

        .result-box .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .result-box .title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .result-box .details {
            font-size: 16px;
            color: #555;
        }

        .comparison-table {
            width: 100%;
            margin-top: 20px;
        }

        .comparison-table td {
            padding: 15px;
            text-align: center;
            width: 50%;
        }

        .comparison-table .value {
            font-size: 28px;
            font-weight: 700;
        }

        .comparison-table .label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .group-a-value {
            color: #2e7d32;
        }

        .group-b-value {
            color: #e65100;
        }

        #copyNotification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }

        #copyNotification.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- LOADER -->
    <div class="loader-overlay hidden" id="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <div class="container">
        <header>
            <h1>üß™ Hypothesis Tester</h1>
            <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö –≥–∏–ø–æ—Ç–µ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets</p>
        </header>

        <!-- Setup Section -->
        <div class="setup-section" id="setupSection">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
            <p>–í—Å—Ç–∞–≤—å URL —Å–≤–æ–µ–≥–æ Google Apps Script –¥–µ–ø–ª–æ—è:</p>
            <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/xxx/exec">
            <br>
            <button onclick="connectToSheets()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <span id="connectionStatus" class="status-badge status-disconnected" style="margin-left: 15px;">–ù–µ
                –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
        </div>

        <!-- Main Form -->
        <div class="card" id="mainForm">
            <h2>üìù –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–∏–ø–æ—Ç–µ–∑—ã</h2>

            <div class="groups-container">
                <!-- Group A -->
                <div class="group-card group-a">
                    <h3>üÖ∞Ô∏è –ì—Ä—É–ø–ø–∞ A (—Ç–µ—Å—Ç–∏—Ä—É–µ–º)</h3>

                    <!-- Hypothesis ID -->
                    <div class="hypothesis-row">
                        <label>üìã Hypothesis ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <select id="hypothesisId">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—É --</option>
                        </select>
                    </div>

                    <div class="hypothesis-row">
                        <label>üìÖ –ü–µ—Ä–∏–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div class="tag-row" style="border-bottom:none; margin-bottom:0; padding-bottom:0;">
                            <select id="monthFromA">
                                <option value="">-- –û—Ç --</option>
                            </select>
                            <select id="monthToA">
                                <option value="">-- –î–æ --</option>
                            </select>
                        </div>
                    </div>

                    <div class="tag-row">
                        <select id="tagType1A" onchange="updateValueDropdown('tagType1A', 'tagValue1A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 1 --</option>
                        </select>
                        <select id="tagValue1A">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>

                    <div class="tag-row">
                        <select id="tagType2A" onchange="updateValueDropdown('tagType2A', 'tagValue2A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 2 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue2A">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>

                    <div class="tag-row">
                        <select id="tagType3A" onchange="updateValueDropdown('tagType3A', 'tagValue3A')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 3 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue3A">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>
                </div>

                <!-- Group B -->
                <div class="group-card group-b">
                    <h3>üÖ±Ô∏è –ì—Ä—É–ø–ø–∞ B (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å)</h3>

                    <!-- Hypothesis ID –¥–ª—è –≥—Ä—É–ø–ø—ã B -->
                    <div class="hypothesis-row">
                        <label>üìã Hypothesis ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <select id="hypothesisIdB">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—É --</option>
                        </select>
                    </div>

                    <div class="hypothesis-row">
                        <label>üìÖ –ü–µ—Ä–∏–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div class="tag-row" style="border-bottom:none; margin-bottom:0; padding-bottom:0;">
                            <select id="monthFromB">
                                <option value="">-- –û—Ç --</option>
                            </select>
                            <select id="monthToB">
                                <option value="">-- –î–æ --</option>
                            </select>
                        </div>
                    </div>

                    <div class="tag-row">
                        <select id="tagType1B" onchange="updateValueDropdown('tagType1B', 'tagValue1B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 1 --</option>
                        </select>
                        <select id="tagValue1B">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>

                    <div class="tag-row">
                        <select id="tagType2B" onchange="updateValueDropdown('tagType2B', 'tagValue2B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 2 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue2B">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>

                    <div class="tag-row">
                        <select id="tagType3B" onchange="updateValueDropdown('tagType3B', 'tagValue3B')">
                            <option value="">-- –¢–∏–ø —Ç–µ–≥–∞ 3 (–æ–ø—Ü.) --</option>
                        </select>
                        <select id="tagValue3B">
                            <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>
                        </select>
                    </div>

                    <div class="static-value-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useStaticValue" onchange="toggleStaticValue()">
                            <span>–°—Ä–∞–≤–Ω–∏—Ç—å —Å–æ —Å—Ç–∞—Ç–∏—á–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º (–±–µ–Ω—á–º–∞—Ä–∫)</span>
                        </label>
                        <input type="number" id="staticValue" class="static-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –±–µ–Ω—á–º–∞—Ä–∫"
                            style="display: none;">
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="card" style="background: #f8f9fa;">
                <h2>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

                <div class="settings-layout">
                    <div>
                        <div class="settings-grid">
                            <div class="setting-item">
                                <label>–ú–µ—Ç—Ä–∏–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</label>
                                <select id="metric">
                                    <option value="CTR">CTR (Click-through Rate)</option>
                                    <option value="CPA_Onboarded">CPA Onboarded</option>
                                    <option value="CPA_Account_Open">CPA Account Open</option>
                                    <option value="CPA_Onboarded_2">CPA Onboarded (Onb>2)</option>
                                    <option value="CR">CR (Account/Onboarded) %</option>
                                    <option value="ThruPlay_Rate">ThruPlay Rate %</option>
                                </select>
                            </div>

                            <div class="setting-item">
                                <label>–£—Å–ª–æ–≤–∏–µ</label>
                                <select id="condition">
                                    <option value="greater">A –±–æ–ª—å—à–µ B</option>
                                    <option value="less">A –º–µ–Ω—å—à–µ B</option>
                                    <option value="greaterPercent">A –±–æ–ª—å—à–µ B –Ω–∞ %</option>
                                    <option value="lessPercent">A –º–µ–Ω—å—à–µ B –Ω–∞ %</option>
                                </select>
                            </div>

                            <div class="setting-item">
                                <label>–ó–Ω–∞—á–µ–Ω–∏–µ % (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)</label>
                                <input type="number" id="conditionValue" min="0" max="100" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä 10">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label
                            style="font-weight: 600; color: #555; font-size: 13px; display: block; margin-bottom: 8px;">–§–∏–ª—å—Ç—Ä
                            –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <div class="filter-row">
                            <select id="filterMetric">
                                <option value="">-- –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ --</option>
                                <option value="Onboarded">Onboarded</option>
                                <option value="Impressions">Impressions</option>
                                <option value="Amount Spent">Amount Spent</option>
                            </select>
                            <select id="filterOperator">
                                <option value=">">&gt;</option>
                                <option value="<">&lt;</option>
                                <option value="=">=</option>
                                <option value=">=">&gt;=</option>
                                <option value="<=">&lt;=</option>
                            </select>
                            <input type="number" id="filterValue" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn-primary" id="runTest" onclick="runHypothesisTest()" disabled>
                    üöÄ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="card hidden" id="resultsSection">
            <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç
                <button class="btn-copy" onclick="copyResultsToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn-analyze" onclick="goToTagAnalysis()">üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–≥–æ–≤ ‚Üí</button>
            </h2>

            <div id="resultBox"></div>

            <div class="details-section" id="detailsSection">
                <h4>üìã –î–µ—Ç–∞–ª–∏ –ø–æ –∫—Ä–µ–∞—Ç–∏–≤–∞–º</h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h5 style="color: #2e7d32; margin-bottom: 10px;">–ì—Ä—É–ø–ø–∞ A (<span id="countA">0</span>
                            –∫—Ä–µ–∞—Ç–∏–≤–æ–≤):</h5>
                        <table class="creatives-table" id="creativesTableA">
                            <thead>
                                <tr>
                                    <th>Ad Name</th>
                                    <th>Spent</th>
                                    <th>Onboarded</th>
                                    <th>CPA</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div id="groupBDetails">
                        <h5 style="color: #e65100; margin-bottom: 10px;">–ì—Ä—É–ø–ø–∞ B (<span id="countB">0</span>
                            –∫—Ä–µ–∞—Ç–∏–≤–æ–≤):</h5>
                        <table class="creatives-table" id="creativesTableB">
                            <thead>
                                <tr>
                                    <th>Ad Name</th>
                                    <th>Spent</th>
                                    <th>Onboarded</th>
                                    <th>CPA</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="copyNotification">‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</div>

    <script>
        // Global data
        let sheetsData = [];
        let tagConfig = {};
        let hypothesisIds = [];
        let lastResult = null;

        // –ú–∞–ø–ø–∏–Ω–≥ —Ç–∏–ø–æ–≤ —Ç–µ–≥–æ–≤ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –≤ Combined_results
        const tagTypeToColumn = {
            'GEO': 'GEO',
            'Language': 'Language',
            'Lane': 'Lane',
            'Campaign Type': 'Campaign_Type',
            'Stage': 'Stage',
            'Style': 'Style',
            'Variable': 'Variable',
            'Variant': 'Variant',
            'Placement': 'Platform/Placement',
            'Format': 'Format',
            'Length': 'Length',
            'CTA_Tag': 'CTA_Tag',
            'Hook_Tag': 'Hook_Tag',
            'Format_Tag': 'Format_Tag',
            'Style_Tag': 'Style_Tag',
            'Audience_Tag': 'Audience_Tag',
            'Visual_Tag': 'Visual_Tag'
        };

        // Initialize tag type dropdowns
        function initTagDropdowns() {
            const selects = ['tagType1A', 'tagType2A', 'tagType3A', 'tagType1B', 'tagType2B', 'tagType3B'];
            const defaultOptions = Object.keys(tagTypeToColumn);

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>';
                defaultOptions.forEach(opt => {
                    select.innerHTML += `<option value="${opt}">${opt}</option>`;
                });
            });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
        function updateValueDropdown(typeSelectId, valueSelectId) {
            const typeSelect = document.getElementById(typeSelectId);
            const valueSelect = document.getElementById(valueSelectId);
            const selectedType = typeSelect.value;

            valueSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ --</option>';

            if (!selectedType) {
                valueSelect.innerHTML = '<option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>';
                return;
            }

            const values = tagConfig[selectedType] || [];

            if (values.length === 0) {
                valueSelect.innerHTML = '<option value="">-- –ù–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–π --</option>';
                return;
            }

            values.forEach(val => {
                if (val) {
                    valueSelect.innerHTML += `<option value="${val}">${val}</option>`;
                }
            });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω Hypothesis ID
        function updateHypothesisDropdown() {
            const selects = [
                document.getElementById('hypothesisId'),
                document.getElementById('hypothesisIdB')
            ];

            selects.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≥–∏–ø–æ—Ç–µ–∑—É --</option>';
                hypothesisIds.forEach(id => {
                    if (id) {
                        select.innerHTML += `<option value="${id}">${id}</option>`;
                    }
                });
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—â—ë –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ
                if (currentVal && hypothesisIds.includes(currentVal)) {
                    select.value = currentVal;
                }
            });
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω—ã –º–µ—Å—è—Ü–µ–≤
        function formatMonthName(dateRangeStr) {
            if (!dateRangeStr || !dateRangeStr.includes('-')) return dateRangeStr;
            const startDate = dateRangeStr.split(' - ')[0];
            const dateObj = new Date(startDate);
            let formatted = dateObj.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            return formatted.charAt(0).toUpperCase() + formatted.slice(1);
        }

        function updateMonthDropdowns() {
            const selects = [
                document.getElementById('monthFromA'),
                document.getElementById('monthToA'),
                document.getElementById('monthFromB'),
                document.getElementById('monthToB')
            ];

            const months = [...new Set(sheetsData.map(row => row['Month']).filter(Boolean))].sort();

            selects.forEach(select => {
                const currentVal = select.value;
                const isFrom = select.id.includes('From');
                select.innerHTML = `<option value="">-- ${isFrom ? '–û—Ç' : '–î–æ'} --</option>`;
                months.forEach(month => {
                    select.innerHTML += `<option value="${month}">${formatMonthName(month)}</option>`;
                });

                if (currentVal && months.includes(currentVal)) {
                    select.value = currentVal;
                }
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ª–æ–∞–¥–µ—Ä
        function showLoader(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...') {
            const loader = document.getElementById('loader');
            const loaderText = loader.querySelector('.loader-text');
            loaderText.textContent = text;

            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        // Connect to Google Sheets
        async function connectToSheets() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                alert('–í–≤–µ–¥–∏—Ç–µ URL Apps Script');
                return;
            }

            const status = document.getElementById('connectionStatus');
            status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
            status.className = 'status-badge';

            showLoader(true, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets...');

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                sheetsData = data.adsData || [];
                tagConfig = data.tagConfig || {};
                hypothesisIds = data.hypothesisIds || [];

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
                try {
                    localStorage.setItem('sheetsData', JSON.stringify(sheetsData));
                    localStorage.setItem('tagConfig', JSON.stringify(tagConfig));
                    localStorage.setItem('hypothesisIds', JSON.stringify(hypothesisIds));
                    localStorage.setItem('sheetsDataTimestamp', new Date().toISOString());
                } catch (e) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ localStorage (–≤–æ–∑–º–æ–∂–Ω–æ, —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –æ–±—ä–µ–º):', e);
                }

                updateTypeDropdownsFromConfig();
                updateHypothesisDropdown();
                updateMonthDropdowns();

                status.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ (${sheetsData.length} —Å—Ç—Ä–æ–∫)`;
                status.className = 'status-badge status-connected';
                document.getElementById('runTest').disabled = false;

                localStorage.setItem('sheetsScriptUrl', url);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã –∏ –¥—Ä–æ–ø–¥–∞—É–Ω—ã –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                setTimeout(() => {
                    restoreFormState();
                }, 300);

            } catch (error) {
                status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                status.className = 'status-badge status-disconnected';
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } finally {
                showLoader(false);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –¥—Ä–æ–ø–¥–∞—É–Ω—ã —Ç–∏–ø–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Config
        function updateTypeDropdownsFromConfig() {
            const selects = ['tagType1A', 'tagType2A', 'tagType3A', 'tagType1B', 'tagType2B', 'tagType3B'];
            const configKeys = Object.keys(tagConfig);

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;

                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø --</option>';
                configKeys.forEach(key => {
                    select.innerHTML += `<option value="${key}">${key}</option>`;
                });

                if (currentValue && configKeys.includes(currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // Toggle static value input
        function toggleStaticValue() {
            const checkbox = document.getElementById('useStaticValue');
            const input = document.getElementById('staticValue');
            const groupBInputs = document.querySelectorAll('#tagType1B, #tagValue1B, #tagType2B, #tagValue2B, #tagType3B, #tagValue3B');

            if (checkbox.checked) {
                input.style.display = 'block';
                groupBInputs.forEach(el => el.disabled = true);
            } else {
                input.style.display = 'none';
                groupBInputs.forEach(el => el.disabled = false);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è "—Ä–µ—Ü–µ–ø—Ç–∞" —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function saveFiltersForAI() {
            console.group("üíæ [index.html] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ—Ü–µ–ø—Ç–∞ –¥–ª—è AI");
            console.time("Recipe Creation");

            try {
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                const recipe = {
                    hypothesisId: document.getElementById('hypothesisId').value,
                    groupA: {
                        monthFrom: document.getElementById('monthFromA').value,
                        monthTo: document.getElementById('monthToA').value,
                        tagType1: document.getElementById('tagType1A').value,
                        tagValue1: document.getElementById('tagValue1A').value,
                        tagType2: document.getElementById('tagType2A').value,
                        tagValue2: document.getElementById('tagValue2A').value,
                        tagType3: document.getElementById('tagType3A').value,
                        tagValue3: document.getElementById('tagValue3A').value
                    },
                    groupB: {
                        hypothesisId: document.getElementById('hypothesisIdB').value,
                        monthFrom: document.getElementById('monthFromB').value,
                        monthTo: document.getElementById('monthToB').value,
                        useStatic: document.getElementById('useStaticValue').checked,
                        staticValue: document.getElementById('staticValue').value,
                        tagType1: document.getElementById('tagType1B').value,
                        tagValue1: document.getElementById('tagValue1B').value,
                        tagType2: document.getElementById('tagType2B').value,
                        tagValue2: document.getElementById('tagValue2B').value,
                        tagType3: document.getElementById('tagType3B').value,
                        tagValue3: document.getElementById('tagValue3B').value
                    },
                    settings: {
                        metric: document.getElementById('metric').value,
                        condition: document.getElementById('condition').value,
                        conditionValue: document.getElementById('conditionValue').value
                    },
                    filter: {
                        metric: document.getElementById('filterMetric').value,
                        operator: document.getElementById('filterOperator').value,
                        value: document.getElementById('filterValue').value
                    },
                    timestamp: new Date().toISOString()
                };

                console.log("‚úÖ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç:", recipe);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã tag_analysis.html
                localStorage.setItem('ai_analysis_recipe', JSON.stringify(recipe));

                // –¢–∞–∫–∂–µ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ URL —Å–∫—Ä–∏–ø—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω (–æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –±—ç–∫)
                const scriptUrl = document.getElementById('scriptUrl').value.trim();
                localStorage.setItem('sheetsScriptUrl', scriptUrl);

                console.log("üìç –†–µ—Ü–µ–ø—Ç –∏ URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage");

            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞:", e);
            } finally {
                console.timeEnd("Recipe Creation");
                console.groupEnd();
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ Combined_results –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –∏–∑ Config
        function getColumnForType(configKey) {
            if (tagTypeToColumn[configKey]) {
                return tagTypeToColumn[configKey];
            }
            return configKey;
        }

        // Filter data by tags
        function filterData(data, tagsArray) {
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ü–µ–ø–æ—á–∫—É
            if (!data || !Array.isArray(data) || data.length === 0) return [];

            // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –∑–∞–¥–∞–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –µ—Å—Ç—å
            if (!tagsArray || tagsArray.length === 0) return data;

            console.log("üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–≥–∞–º (–æ–±—ä–µ–∫—Ç—ã):", tagsArray);

            return data.filter(row => {
                // –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –í–°–ï–ú –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–µ–≥–∞–º (–ª–æ–≥–∏–∫–∞ AND)
                return tagsArray.every(tag => {
                    const key = tag.type;
                    const val = tag.value;

                    if (!val || val === 'all') return true;

                    // –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø VISUAL TAG
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ª—é–±–æ–π –∏–∑ —Ç—Ä–µ—Ö –∫–æ–ª–æ–Ω–æ–∫ –æ–±—ä–µ–∫—Ç–∞
                    if (key === 'Visual_Tag') {
                        const v1 = String(row['Visual_Tag_1'] || "").trim();
                        const v2 = String(row['Visual_Tag_2'] || "").trim();
                        const v3 = String(row['Visual_Tag_3'] || "").trim();


                        return v1 === val || v2 === val || v3 === val;
                    }

                    // –û–ë–´–ß–ù–ê–Ø –õ–û–ì–ò–ö–ê
                    const colName = tagTypeToColumn[key] || key;
                    const rowValue = String(row[colName] || "").trim();

                    return rowValue === val;
                });
            });
        }

        function filterByHypothesis(data, hypId) {
            if (!data || !Array.isArray(data)) return []; // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (!hypId || hypId === 'all') return data;

            return data.filter(row => row['Hypothesis ID'] === hypId);
        }

        function applyDataFilter(data) {
            if (!data || !Array.isArray(data)) return [];

            const filterMetric = document.getElementById('filterMetric').value;
            const filterOperator = document.getElementById('filterOperator').value;
            const filterValue = parseFloat(document.getElementById('filterValue').value) || 0;

            if (!filterMetric || filterMetric === 'none') return data;

            return data.filter(row => {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–ª—é—á—É-–º–µ—Ç—Ä–∏–∫–µ
                const value = parseFloat(row[filterMetric]) || 0;
                switch (filterOperator) {
                    case '>': return value > filterValue;
                    case '<': return value < filterValue;
                    case '=': return value === filterValue;
                    case '>=': return value >= filterValue;
                    case '<=': return value <= filterValue;
                    default: return true;
                }
            });
        }

        // Calculate metric for a dataset
        function calculateMetric(data, metric) {
            if (data.length === 0) return null;

            // –î–ª—è CPA Onboarded (Onb>2) ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            let filteredData = data;
            if (metric === 'CPA_Onboarded_2') {
                filteredData = data.filter(row => (parseFloat(row['Onboarded']) || 0) > 2);
                if (filteredData.length === 0) return null;
            }

            const totalSpent = filteredData.reduce((sum, row) => sum + (parseFloat(row['Amount Spent']) || 0), 0);
            const totalOnboarded = filteredData.reduce((sum, row) => sum + (parseFloat(row['Onboarded']) || 0), 0);
            const totalAccountOpened = filteredData.reduce((sum, row) => sum + (parseFloat(row['OBA: Account Opened']) || 0), 0);
            const totalImpressions = filteredData.reduce((sum, row) => sum + (parseFloat(row['Impressions']) || 0), 0);
            const totalThruPlays = filteredData.reduce((sum, row) => sum + (parseFloat(row['ThruPlays']) || 0), 0);

            // CTR –±–µ—Ä—ë–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ –∏ —É—Å—Ä–µ–¥–Ω—è–µ–º
            const ctrValues = filteredData.map(row => parseFloat(row['CTR (Link Click-Through Rate)']) || 0).filter(v => v > 0);
            const avgCTR = ctrValues.length > 0 ? ctrValues.reduce((a, b) => a + b, 0) / ctrValues.length : null;

            switch (metric) {
                case 'CTR':
                    return avgCTR;
                case 'CPA_Onboarded':
                    return totalOnboarded > 0 ? totalSpent / totalOnboarded : null;
                case 'CPA_Account_Open':
                    return totalAccountOpened > 0 ? totalSpent / totalAccountOpened : null;
                case 'CPA_Onboarded_2':
                    return totalOnboarded > 0 ? totalSpent / totalOnboarded : null;
                case 'CR':
                    return totalOnboarded > 0 ? (totalAccountOpened / totalOnboarded) * 100 : null;
                case 'ThruPlay_Rate':
                    return totalImpressions > 0 ? (totalThruPlays / totalImpressions) * 100 : null;
                default:
                    return null;
            }
        }

        // Check if hypothesis passed
        function checkCondition(valueA, valueB, condition, conditionValue) {
            if (valueA === null || valueB === null) return null;

            switch (condition) {
                case 'greater':
                    return valueA > valueB;
                case 'less':
                    return valueA < valueB;
                case 'greaterPercent':
                    return valueA > valueB * (1 + conditionValue / 100);
                case 'lessPercent':
                    return valueA < valueB * (1 - conditionValue / 100);
                default:
                    return null;
            }
        }

        // Get metric display name
        function getMetricName(metric) {
            const names = {
                'CTR': 'CTR',
                'CPA_Onboarded': 'CPA Onboarded',
                'CPA_Account_Open': 'CPA Account Open',
                'CPA_Onboarded_2': 'CPA Onboarded (Onb>2)',
                'CR': 'CR (Account/Onboarded)',
                'ThruPlay_Rate': 'ThruPlay Rate'
            };
            return names[metric] || metric;
        }

        // Format value based on metric
        function formatValue(value, metric) {
            if (value === null) return 'N/A';

            if (metric.includes('CPA')) {
                return '‚Ç¨' + value.toFixed(2);
            } else if (metric === 'CR' || metric === 'ThruPlay_Rate' || metric === 'CTR') {
                return value.toFixed(2) + '%';
            }
            return value.toFixed(2);
        }

        // Run the hypothesis test
        function runHypothesisTest() {
            console.log("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –≥–∏–ø–æ—Ç–µ–∑—ã...");
            saveFiltersForAI();
            const hypIdA = document.getElementById('hypothesisId').value;
            const hypIdB = document.getElementById('hypothesisIdB').value;

            const monthFromA = document.getElementById('monthFromA').value;
            const monthToA = document.getElementById('monthToA').value;
            const monthFromB = document.getElementById('monthFromB').value;
            const monthToB = document.getElementById('monthToB').value;

            // Get tags for Group A
            const tagsA = [
                { type: document.getElementById('tagType1A').value, value: document.getElementById('tagValue1A').value },
                { type: document.getElementById('tagType2A').value, value: document.getElementById('tagValue2A').value },
                { type: document.getElementById('tagType3A').value, value: document.getElementById('tagValue3A').value }
            ].filter(t => t.type && t.value);

            // Get tags for Group B
            const useStatic = document.getElementById('useStaticValue').checked;
            const staticValue = parseFloat(document.getElementById('staticValue').value) || 0;

            const tagsB = useStatic ? [] : [
                { type: document.getElementById('tagType1B').value, value: document.getElementById('tagValue1B').value },
                { type: document.getElementById('tagType2B').value, value: document.getElementById('tagValue2B').value },
                { type: document.getElementById('tagType3B').value, value: document.getElementById('tagValue3B').value }
            ].filter(t => t.type && t.value);

            // Get settings
            const metric = document.getElementById('metric').value;
            const condition = document.getElementById('condition').value;
            const conditionValue = parseFloat(document.getElementById('conditionValue').value) || 0;

            // –ë–∞–∑–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –º–µ—Ç—Ä–∏–∫–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
            const baseData = applyDataFilter(sheetsData);

            // –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ —Å–≤–æ–µ–º—É Hypothesis ID –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
            let baseA = filterByHypothesis(baseData, hypIdA);
            let baseB = filterByHypothesis(baseData, hypIdB);

            // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ö–æ–∂–¥–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ Month –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥
            function filterByDateRange(data, monthFrom, monthTo) {
                if (!monthFrom && !monthTo) return data;

                return data.filter(row => {
                    const rowMonth = row['Month'];
                    if (!rowMonth) return false;

                    const [rowStart, rowEnd] = rowMonth.split(' - ');

                    let passesFrom = true;
                    if (monthFrom) {
                        const [fromStart] = monthFrom.split(' - ');
                        passesFrom = rowStart >= fromStart;
                    }

                    let passesTo = true;
                    if (monthTo) {
                        const [, toEnd] = monthTo.split(' - ');
                        passesTo = rowEnd <= toEnd;
                    }

                    return passesFrom && passesTo;
                });
            }

            baseA = filterByDateRange(baseA, monthFromA, monthToA);
            baseB = filterByDateRange(baseB, monthFromB, monthToB);

            console.log(`üìå Group A: Hypothesis="${hypIdA}", Month="${monthFromA || 'Any'} - ${monthToA || 'Any'}" ‚Üí ${baseA.length} —Å—Ç—Ä–æ–∫ –±–∞–∑—ã`);
            console.log(`üìå Group B: Hypothesis="${hypIdB}", Month="${monthFromB || 'Any'} - ${monthToB || 'Any'}" ‚Üí ${baseB.length} —Å—Ç—Ä–æ–∫ –±–∞–∑—ã`);

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–≥–∏ –∫ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ
            const dataA = filterData(baseA, tagsA);
            const dataB = useStatic ? [] : filterData(baseB, tagsB);

            // Calculate metrics
            const valueA = calculateMetric(dataA, metric);
            const valueB = useStatic ? staticValue : calculateMetric(dataB, metric);

            // Check condition
            const passed = checkCondition(valueA, valueB, condition, conditionValue);

            // Calculate difference
            const diff = valueA !== null && valueB !== null && valueB !== 0
                ? ((valueA - valueB) / valueB * 100)
                : null;

            // Store result
            lastResult = {
                valueA,
                valueB,
                diff,
                passed,
                dataA,
                dataB,
                metric,
                useStatic
            };

            // Display results
            displayResults(lastResult);
        }

        // Display results
        function displayResults(result) {
            document.getElementById('resultsSection').classList.remove('hidden');

            const metric = result.metric;
            const metricName = getMetricName(metric);

            // Result box
            let boxClass, icon, title;
            if (result.passed === true) {
                boxClass = 'success';
                icon = '‚úÖ';
                title = '–ì–∏–ø–æ—Ç–µ–∑–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!';
            } else if (result.passed === false) {
                boxClass = 'fail';
                icon = '‚ùå';
                title = '–ì–∏–ø–æ—Ç–µ–∑–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞';
            } else {
                boxClass = 'nodata';
                icon = '‚ö†Ô∏è';
                title = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö';
            }

            const diffText = result.diff !== null
                ? `–†–∞–∑–Ω–∏—Ü–∞: ${result.diff >= 0 ? '+' : ''}${result.diff.toFixed(1)}%`
                : '';

            document.getElementById('resultBox').innerHTML = `
                <div class="result-box ${boxClass}">
                    <div class="icon">${icon}</div>
                    <div class="title">${title}</div>
                    <div class="details">${metricName}: ${diffText}</div>
                    
                    <table class="comparison-table">
                        <tr>
                            <td>
                                <div class="value group-a-value">${formatValue(result.valueA, metric)}</div>
                                <div class="label">–ì—Ä—É–ø–ø–∞ A (${result.dataA.length} –∫—Ä–µ–∞—Ç–∏–≤–æ–≤)</div>
                            </td>
                            <td>
                                <div class="value group-b-value">${formatValue(result.valueB, metric)}</div>
                                <div class="label">${result.useStatic ? '–ë–µ–Ω—á–º–∞—Ä–∫' : '–ì—Ä—É–ø–ø–∞ B (' + result.dataB.length + ' –∫—Ä–µ–∞—Ç–∏–≤–æ–≤)'}</div>
                            </td>
                        </tr>
                    </table>
                </div>
            `;

            // Group A table
            document.getElementById('countA').textContent = result.dataA.length;
            const tbodyA = document.querySelector('#creativesTableA tbody');
            tbodyA.innerHTML = '';
            result.dataA.slice(0, 20).forEach(row => {
                const spent = parseFloat(row['Amount Spent']) || 0;
                const onb = parseFloat(row['Onboarded']) || 0;
                const cpa = onb > 0 ? (spent / onb).toFixed(2) : 'N/A';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Ad Name'] || 'N/A'}</td>
                    <td>‚Ç¨${spent.toFixed(2)}</td>
                    <td>${onb}</td>
                    <td>${cpa}</td>
                `;
                tbodyA.appendChild(tr);
            });

            // Group B table (hide if static)
            const groupBDetails = document.getElementById('groupBDetails');
            if (result.useStatic) {
                groupBDetails.style.display = 'none';
            } else {
                groupBDetails.style.display = 'block';
                document.getElementById('countB').textContent = result.dataB.length;
                const tbodyB = document.querySelector('#creativesTableB tbody');
                tbodyB.innerHTML = '';
                result.dataB.slice(0, 20).forEach(row => {
                    const spent = parseFloat(row['Amount Spent']) || 0;
                    const onb = parseFloat(row['Onboarded']) || 0;
                    const cpa = onb > 0 ? (spent / onb).toFixed(2) : 'N/A';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row['Ad Name'] || 'N/A'}</td>
                        <td>‚Ç¨${spent.toFixed(2)}</td>
                        <td>${onb}</td>
                        <td>${cpa}</td>
                    `;
                    tbodyB.appendChild(tr);
                });
            }
        }


        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã (–±–µ–∑ –±–æ–ª—å—à–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤ –¥–∞–Ω–Ω—ã—Ö)
        function saveFormState() {
            const state = {
                // –ì—Ä—É–ø–ø–∞ A
                hypothesisId: document.getElementById('hypothesisId').value,
                monthFromA: document.getElementById('monthFromA').value,
                monthToA: document.getElementById('monthToA').value,
                tagType1A: document.getElementById('tagType1A').value,
                tagValue1A: document.getElementById('tagValue1A').value,
                tagType2A: document.getElementById('tagType2A').value,
                tagValue2A: document.getElementById('tagValue2A').value,
                tagType3A: document.getElementById('tagType3A').value,
                tagValue3A: document.getElementById('tagValue3A').value,
                // –ì—Ä—É–ø–ø–∞ B
                hypothesisIdB: document.getElementById('hypothesisIdB').value,
                monthFromB: document.getElementById('monthFromB').value,
                monthToB: document.getElementById('monthToB').value,
                tagType1B: document.getElementById('tagType1B').value,
                tagValue1B: document.getElementById('tagValue1B').value,
                tagType2B: document.getElementById('tagType2B').value,
                tagValue2B: document.getElementById('tagValue2B').value,
                tagType3B: document.getElementById('tagType3B').value,
                tagValue3B: document.getElementById('tagValue3B').value,
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                metric: document.getElementById('metric').value,
                condition: document.getElementById('condition').value,
                conditionValue: document.getElementById('conditionValue').value,
                // –§–∏–ª—å—Ç—Ä—ã
                filterMetric: document.getElementById('filterMetric').value,
                filterOperator: document.getElementById('filterOperator').value,
                filterValue: document.getElementById('filterValue').value,
                // –°—Ç–∞—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                useStaticValue: document.getElementById('useStaticValue').checked,
                staticValue: document.getElementById('staticValue').value,
                // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –±–µ–∑ –±–æ–ª—å—à–∏—Ö –º–∞—Å—Å–∏–≤–æ–≤)
                hasResult: !!lastResult,
                resultMeta: lastResult ? {
                    metric: lastResult.metric,
                    valueA: lastResult.valueA,
                    valueB: lastResult.valueB,
                    diff: lastResult.diff,
                    passed: lastResult.passed,
                    useStatic: lastResult.useStatic,
                    countA: lastResult.dataA ? lastResult.dataA.length : 0,
                    countB: lastResult.dataB ? lastResult.dataB.length : 0
                } : null
            };
            localStorage.setItem('indexFormState', JSON.stringify(state));
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –¥—Ä–æ–ø–¥–∞—É–Ω–µ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        function restoreDropdownValue(typeSelectId, valueSelectId, typeValue, valueValue) {
            if (!typeValue) return;

            const typeSelect = document.getElementById(typeSelectId);
            const valueSelect = document.getElementById(valueSelectId);

            if (!typeSelect || !valueSelect) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥—Ä–æ–ø–¥–∞—É–Ω–∞ (tagConfig –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω)
            if (Object.keys(tagConfig).length === 0) {
                // –î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–ø–∞
                typeSelect.value = typeValue;
                return;
            }

            typeSelect.value = typeValue;
            updateValueDropdown(typeSelectId, valueSelectId);

            // –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–π
            const checkValue = () => {
                if (valueSelect.options.length > 1) {
                    if (valueValue) {
                        valueSelect.value = valueValue;
                    }
                } else {
                    setTimeout(checkValue, 50);
                }
            };
            setTimeout(checkValue, 100);
        }

        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã
        function restoreFormState() {
            const stateStr = localStorage.getItem('indexFormState');
            if (!stateStr) return;

            try {
                const state = JSON.parse(stateStr);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã A
                if (state.hypothesisId) document.getElementById('hypothesisId').value = state.hypothesisId;
                if (state.monthFromA) document.getElementById('monthFromA').value = state.monthFromA;
                if (state.monthToA) document.getElementById('monthToA').value = state.monthToA;
                if (state.tagType1A) restoreDropdownValue('tagType1A', 'tagValue1A', state.tagType1A, state.tagValue1A);
                if (state.tagType2A) restoreDropdownValue('tagType2A', 'tagValue2A', state.tagType2A, state.tagValue2A);
                if (state.tagType3A) restoreDropdownValue('tagType3A', 'tagValue3A', state.tagType3A, state.tagValue3A);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã B
                if (state.hypothesisIdB) document.getElementById('hypothesisIdB').value = state.hypothesisIdB;
                if (state.monthFromB) document.getElementById('monthFromB').value = state.monthFromB;
                if (state.monthToB) document.getElementById('monthToB').value = state.monthToB;
                if (state.tagType1B) restoreDropdownValue('tagType1B', 'tagValue1B', state.tagType1B, state.tagValue1B);
                if (state.tagType2B) restoreDropdownValue('tagType2B', 'tagValue2B', state.tagType2B, state.tagValue2B);
                if (state.tagType3B) restoreDropdownValue('tagType3B', 'tagValue3B', state.tagType3B, state.tagValue3B);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                if (state.metric) document.getElementById('metric').value = state.metric;
                if (state.condition) document.getElementById('condition').value = state.condition;
                if (state.conditionValue !== undefined) document.getElementById('conditionValue').value = state.conditionValue;

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                if (state.filterMetric) document.getElementById('filterMetric').value = state.filterMetric;
                if (state.filterOperator) document.getElementById('filterOperator').value = state.filterOperator;
                if (state.filterValue !== undefined) document.getElementById('filterValue').value = state.filterValue;

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                if (state.useStaticValue !== undefined) {
                    document.getElementById('useStaticValue').checked = state.useStaticValue;
                    toggleStaticValue();
                    if (state.staticValue !== undefined) document.getElementById('staticValue').value = state.staticValue;
                }

                // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è:', e);
            }
        }

        // Go to tag analysis page
        function goToTagAnalysis() {
            if (!lastResult || lastResult.dataA.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –≥—Ä—É–ø–ø–µ A');
                return;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
            saveFormState();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ü–µ–ø—Ç –¥–ª—è AI –∞–Ω–∞–ª–∏–∑–∞ (–Ω—É–∂–µ–Ω –¥–ª—è tag_analysis.html)
            saveFiltersForAI();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
            const analysisData = {
                hypothesisId: document.getElementById('hypothesisId').value || null,
                metric: lastResult.metric,
                passed: lastResult.passed,
                valueA: lastResult.valueA,
                valueB: lastResult.valueB,
                diff: lastResult.diff,
                creatives: lastResult.dataA
            };

            localStorage.setItem('tagAnalysisData', JSON.stringify(analysisData));

            // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–Ω–∞–ª–∏–∑–∞
            window.location.href = 'tag_analysis.html';
        }

        // Copy results to clipboard
        function copyResultsToClipboard() {
            if (!lastResult) return;

            const hypId = document.getElementById('hypothesisId').value || 'N/A';
            const metric = getMetricName(lastResult.metric);
            const valueA = formatValue(lastResult.valueA, lastResult.metric);
            const valueB = formatValue(lastResult.valueB, lastResult.metric);
            const diff = lastResult.diff !== null ? lastResult.diff.toFixed(1) + '%' : 'N/A';
            const passed = lastResult.passed === true ? '–î–∞' :
                lastResult.passed === false ? '–ù–µ—Ç' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

            const text = `Hypothesis ID\t${hypId}
        –ú–µ—Ç—Ä–∏–∫–∞\t${metric}
        –ì—Ä—É–ø–ø–∞ A\t${valueA}
        –ì—Ä—É–ø–ø–∞ B\t${valueB}
        –†–∞–∑–Ω–∏—Ü–∞\t${diff}
        –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞\t${passed}
        –ö—Ä–µ–∞—Ç–∏–≤–æ–≤ A\t${lastResult.dataA.length}
        –ö—Ä–µ–∞—Ç–∏–≤–æ–≤ B\t${lastResult.dataB.length}`;

            navigator.clipboard.writeText(text).then(() => {
                const notification = document.getElementById('copyNotification');
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 2000);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
        function loadDataFromStorage() {
            try {
                const savedSheetsData = localStorage.getItem('sheetsData');
                const savedTagConfig = localStorage.getItem('tagConfig');
                const savedHypothesisIds = localStorage.getItem('hypothesisIds');

                if (savedSheetsData && savedTagConfig && savedHypothesisIds) {
                    sheetsData = JSON.parse(savedSheetsData);
                    tagConfig = JSON.parse(savedTagConfig);
                    hypothesisIds = JSON.parse(savedHypothesisIds);

                    updateTypeDropdownsFromConfig();
                    updateHypothesisDropdown();
                    updateMonthDropdowns();

                    const status = document.getElementById('connectionStatus');
                    const timestamp = localStorage.getItem('sheetsDataTimestamp');
                    const dateStr = timestamp ? new Date(timestamp).toLocaleString('ru-RU') : '';
                    status.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ (${sheetsData.length} —Å—Ç—Ä–æ–∫)${dateStr ? ' - ' + dateStr : ''}`;
                    status.className = 'status-badge status-connected';
                    document.getElementById('runTest').disabled = false;

                    return true;
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage:', e);
            }
            return false;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTagDropdowns();

            const savedUrl = localStorage.getItem('sheetsScriptUrl');
            if (savedUrl) {
                document.getElementById('scriptUrl').value = savedUrl;

                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                const dataLoaded = loadDataFromStorage();

                if (dataLoaded) {
                    // –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã
                    setTimeout(() => {
                        restoreFormState();
                    }, 200);
                } else {
                    // –î–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ –∫—ç—à–µ, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Google Sheets
                    connectToSheets();
                }
            } else {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å —Å tag_analysis)
                setTimeout(() => {
                    restoreFormState();
                }, 100);
            }
        });




    </script>
</body>

</html>